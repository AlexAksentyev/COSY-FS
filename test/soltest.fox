INCLUDE 'bin/setups/BNL';

FUNCTION MRK I; MRK := LTRIM(SF(I, '(I4)')); ENDFUNCTION;
FUNCTION GET0 MU NBAR;
  GET0 := FORM((MU|0)&(NBAR(1)|0)&(NBAR(2)|0)&(NBAR(3)|0));
ENDFUNCTION;

PROCEDURE STEERER I;
  VARIABLE ANGLE 1;
  ANGLE := 90;
  RSY -ANGLE; CMSI I 1E6 5E-2 1; RSY ANGLE;
ENDPROCEDURE;

PROCEDURE OPTIM_NRG GSX GSY GSD TILTS CUR EN;
  VARIABLE MU 800; VARIABLE NBAR 800 3; VARIABLE OBJ 1;
  VARIABLE KICK 1;
  { IF RE(TILTS)=0; KICK := .1; ENDIF; }
  IF  CUR=0; KICK := .1; ENDIF;
  WRITE 6 'KICK = '&ST(KICK);
  WRITE 6 'RE(TILTS) = '&ST(RE(TILTS));
  WRITE 6 'CUR = '&ST(CUR);
  FIT EN;
    RP EN 1876.5592/AMUMEV 1;
    RPS 1 -.142987;
    CW_SETUP GSX GSY GSD TILTS; STEERER CUR; RSX KICK;
    TSS MU NBAR 0;
    OBJ :=  (SQR(CONS(NBAR(2))) + SQR(CONS(NBAR(3))))/SQR(CONS(NBAR(1)));
    WRITE 6 'EN & OBJ' EN&OBJ;
  ENDFIT 1E-5 1000 1 OBJ;
  WRITE 6 'RESULT'  FORM(EN&(MU|0)&(NBAR(1)|0)&(NBAR(2)|0)&(NBAR(3)|0));
ENDPROCEDURE;

PROCEDURE RUN;
  VARIABLE WHERE 500; VARIABLE MARKER 100;
  VARIABLE I 1; VARIABLE CUR0 1; VARIABLE CUR 1;
  VARIABLE MU 800; VARIABLE NBAR 800 3;
  VARIABLE TILTS 32;
  VARIABLE GSX 1; VARIABLE GSY 1; VARIABLE GSD 1;
  VARIABLE EN 1;

 { DATA OUTPUT DIRECTORY }
  WRITE 6 '';
  WHERE := 'data/soltest/';
    OS 'mkdir -p '&WHERE;  WRITE 6 'WRITING TO: '&WHERE;
    OS 'rm -vf '&WHERE&'*';
    OS 'mkdir -p img/BNL/';
  GROUTF 'img/BNL/TR' 1;
  MARKER :='';

  { SIMULATION PARAMETERS }
  OV 5 3 0;
  RP 270.0092 1876.5592/AMUMEV 1;
  RPS 1 -.142987;

  { EN := 270.0092; }
  TILTS := ZEROS(32);

  {SIMULATION}
  OPENF 7 WHERE&'STUNE.dat' 'REPLACE';
  LOOP I 1 11; CUR := .1*(I-6);
    { VELSET TILTS 3 CUR; }
    { OPTIM_NRG GSX GSY GSD TILTS CUR EN; }
    { RP EN 1876.5592/AMUMEV 1; RPS 1 -.142987; }
    CW_SETUP GSX GSY GSD TILTS;
    STEERER CUR;
    TSS MU NBAR 0;
    WRITE 6 ST(CUR)&' '&GET0(MU, NBAR);
    WRITE 7 ST(CUR)&' '&GET0(MU, NBAR);
  ENDLOOP;
  CLOSEF 7;
ENDPROCEDURE; {RUN}

RUN; END;
